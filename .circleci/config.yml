version: 2.1

orbs:
  ci: bigcommerce/internal@volatile
  php: bigcommerce/internal-php@volatile

php_matrix: &php_matrix
  matrix:
    parameters:
      php-version: [ "8.0", "8.1", "8.2" ]
jobs:
  codesniffer:
    parameters:
      php-version:
        type: string
        default: "8.0"
    executor:
      name: php/php
      php-version: << parameters.php-version >>
    steps:
      - ci/pre-setup
      - php/install-extensions:
          additional_apt_packages: ''
          additional_php_extensions: ''
          additional_pecl_extensions: ''
      - php/composer-install
      - run: ./vendor/bin/phpcs --standard=PSR2 --ignore=src/Grphp/grpc.stubs.php src
  cs-fixer:
    parameters:
      php-version:
        type: string
        default: "8.0"
    executor:
      name: php/php
      php-version: << parameters.php-version >>
    steps:
      - ci/pre-setup
      - php/install-extensions:
          additional_apt_packages: ''
          additional_php_extensions: ''
          additional_pecl_extensions: ''
      - php/composer-install
      - run: ./vendor/bin/php-cs-fixer fix --diff --dry-run -v

workflows:
  version: 2
  full:
    jobs:
      - php/static-analysis:
          <<: *php_matrix
      - php/phpunit-tests:
          configuration: "phpunit.xml.dist"
          pecl_extensions: "grpc"
          <<: *php_matrix
      - codesniffer:
          <<: *php_matrix
      - cs-fixer:
          <<: *php_matrix
